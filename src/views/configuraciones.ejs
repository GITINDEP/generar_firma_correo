<%- include('partials/head') %>

<div class="container-fluid shadow-lg p-3 mb-5 bg-body-tertiary rounded">
   <div class="titulo">
        <div class="titulo_p">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Zm70-80h79l14-106q31-8 57.5-23.5T639-327l99 41 39-68-86-65q5-14 7-29.5t2-31.5q0-16-2-31.5t-7-29.5l86-65-39-68-99 42q-22-23-48.5-38.5T533-694l-13-106h-79l-14 106q-31 8-57.5 23.5T321-633l-99-41-39 68 86 64q-5 15-7 30t-2 32q0 16 2 31t7 30l-86 65 39 68 99-42q22 23 48.5 38.5T427-266l13 106Zm42-180q58 0 99-41t41-99q0-58-41-99t-99-41q-59 0-99.5 41T342-480q0 58 40.5 99t99.5 41Zm-2-140Z"/></svg>
            Configuración
        </div>
        <div class="menu">
            <div class="rutas">
                <a href="/inicio">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M560-440h200v-80H560v80Zm0-120h200v-80H560v80ZM200-320h320v-22q0-45-44-71.5T360-440q-72 0-116 26.5T200-342v22Zm160-160q33 0 56.5-23.5T440-560q0-33-23.5-56.5T360-640q-33 0-56.5 23.5T280-560q0 33 23.5 56.5T360-480ZM160-160q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h640q33 0 56.5 23.5T880-720v480q0 33-23.5 56.5T800-160H160Zm0-80h640v-480H160v480Zm0 0v-480 480Z"/></svg>
                    Firma
                </a>
            </div>
            <div class="opciones">
                <a href="/logout">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M200-120q-33 0-56.5-23.5T120-200v-160h80v160h560v-560H200v160h-80v-160q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm220-160-56-58 102-102H120v-80h346L364-622l56-58 200 200-200 200Z"/></svg>
                    Cerrar Sesión
                </a>
            </div>
        </div>
    </div>

    <form action="" class="mt-4">
        <div class="row ">
        
            <div class="col-sm-12 col-md-12 mb-3 shadow-lg p-3 mb-5 bg-body-tertiary rounded ">
                 <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="32px" fill="#000"><path d="m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Zm70-80h79l14-106q31-8 57.5-23.5T639-327l99 41 39-68-86-65q5-14 7-29.5t2-31.5q0-16-2-31.5t-7-29.5l86-65-39-68-99 42q-22-23-48.5-38.5T533-694l-13-106h-79l-14 106q-31 8-57.5 23.5T321-633l-99-41-39 68 86 64q-5 15-7 30t-2 32q0 16 2 31t7 30l-86 65 39 68 99-42q22 23 48.5 38.5T427-266l13 106Zm42-180q58 0 99-41t41-99q0-58-41-99t-99-41q-59 0-99.5 41T342-480q0 58 40.5 99t99.5 41Zm-2-140Z"/></svg>
                    Opciones de Configuración
                </h3>
                <hr>
                <div class="row">
                    <form action="" id="formConfiguraciones">
                        <div class="col-sm-12 col-md-3 mb-3">
                            <div class="mb-3">
                                <label for="exampleFormControlInput1" class="form-label">Color de letra: <span style="color:red;font-weight:800">*</span></label>
                                <input type="color" class="form-control form-control-color" id="color_letra" name="color_letra" value="#611232" title="Seleccione un color">
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-3 mb-3">
                            <div class="mb-3">
                                <label for="exampleFormControlInput1" class="form-label">Tamaño de letra: <span style="color:red;font-weight:800">*</span></label>
                                <input type="number" class="form-control" id="tamanio_letra" name="tamanio_letra" placeholder="">
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-3 mb-3">
                            <label for="formFile" class="form-label">Estilo de letra:</label>
                            <select class="form-select" aria-label="Default select example" id="estilo_letra" name="estilo_letra">
                            <option selected value="">--Seleccione--</option>
                            <option value="bold">Negrita</option>
                            <option value="italic">Cursiva</option>
                            </select>
                        </div>
                        <div class="col-sm-12 col-md-3 mb-3">
                            <label for="formFile" class="form-label">Apartado: <span style="color:red;font-weight:800">*</span></label>
                            <select class="form-select" aria-label="Default select example" id="fk_id_cat_apartado_firma" name="fk_id_cat_apartado_firma">
                                <option selected value="">--Seleccione--</option>
                                <% for(let apartado of apartados){%>
                                    <option value="<%=apartado.id_cat_apartado_firma%>"><%=apartado.apartado_firma%></option>
                                <%}%>
                            </select>
                        </div>
                    </form>
                </div>
                <button class="btn success mb-3" type="button" onclick="addConfiguracion()">
                    <div class=""><img src="/assets/img/icons/agregar.svg"></div>
                    <div class="title">AGREGAR</div>
                </button>
                <div class="col-sm-12 col-md-12 mb-3">
                   <div class="table-container">
                       <table class="table-gral table-responsive" id="tablaConfiguraciones">

                       </table>
                   </div>
                </div>
            </div>
            <div class="col-sm-12 col-md-12 mb-3 shadow-lg p-3 mb-5 bg-body-tertiary rounded ">
                    <h3>
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="32px" fill="#000"><path d="m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Zm70-80h79l14-106q31-8 57.5-23.5T639-327l99 41 39-68-86-65q5-14 7-29.5t2-31.5q0-16-2-31.5t-7-29.5l86-65-39-68-99 42q-22-23-48.5-38.5T533-694l-13-106h-79l-14 106q-31 8-57.5 23.5T321-633l-99-41-39 68 86 64q-5 15-7 30t-2 32q0 16 2 31t7 30l-86 65 39 68 99-42q22 23 48.5 38.5T427-266l13 106Zm42-180q58 0 99-41t41-99q0-58-41-99t-99-41q-59 0-99.5 41T342-480q0 58 40.5 99t99.5 41Zm-2-140Z"/></svg>
                        Configuración de Imagenes de Firma.
                    </h3>
                    <hr>
                    <div class="col-sm-12 col-md-12 mb-3">
                        <form action="" id="formArchivos" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="formFile" class="form-label">Seleccione un archivo a subir.</label>
                                <input type="file" accept="image/*" onchange="previewImage(event, '#imgPreview')" id="file" name="file">
                            </div>
                        </form>
                    </div>
                    <div class="col-sm-12 col-md-12 mb-3" style="width: 100%;">
                        <img id="imgPreview" width="60%">
                    </div>
                    <button class="btn success mb-3" type="button" onclick="agregarArchivo()">
                        <div class=""><img src="/assets/img/icons/agregar.svg"></div>
                        <div class="title">AGREGAR</div>
                    </button>
                    <div class="col-sm-12 col-md-12 mb-3">
                        <div class="table-container">
                            <table class="table-gral table-responsive" id="tablaArchivos">
                            </table>
                        </div>
                    </div>
</div>
        </div>
    </form>
</div>

<script>

function dataTableConfig(tabla,columnas,datos){

    let dataTableOptions={
         columnDefs: [
             { minWidth: '200px', targets: 0 },
             { maxWidth: '300px', targets: 1 }
         ],
          columns: columnas,
          data:datos,
         language:{
             info:       'Registro _START_ al  _END_ de _TOTAL_ , (Página _PAGE_ de _PAGES_ Páginas)',
             paginate: {
                 first:      'Primero',
                 last:       'Último',
                 next:       'Siguiente',
                 previous:   'Anterior'
                 },
             lengthMenu: 'Ver _MENU_ Registros por página',
             search:     'Buscar: ',
             zeroRecords:'No existe registro'
         },
         initComplete: function () {
 
         }
     };
     
     $(`#${tabla}`).dataTable(dataTableOptions);

} 

async function fechData(url,metodo,body=null){
      try {
        let configuracionFetch ={
            method:metodo,
            headers: {
                    "Content-Type": "application/json",
                    },
            }
            if(body!= null){
                configuracionFetch.body=body
            }
            const response = await fetch(url,configuracionFetch); 
            const data = await response.json();
            console.log('data',data);
            return data;

        } catch (error) {
            console.error('Error al obtener los datos:', error);
        }
}
fechData('/configuracion/files/getAll','GET')
.then((result)=>{
    dataTableConfig('tablaArchivos',
                    [
                        {
                            data:'ruta_archivo',
                            title:'Archivo',
                            render:function(data,type,row){
                                return `<a href="${data}" target="_blank">imagen_${row.id_archivo}</a>`
                            }
                        },
                        {data:'tamanio_archivo',title:'Tamaño del Archivo'},
                        {data:'tipo_archivo',title:'Tipo del Archivo'},
                        {
                            data:'activo',
                            title:'Seleccionar',
                            render: function(data, type, row) {
                                if (data === true) {
                                    return '<span class="badge text-bg-success" >Seleccionado</span>';
                                } else {
                                    // Si está inactivo, muestra botón
                                    return `
                                    <button class="btn primary" type="button" onclick="activarImage(${row.id_archivo})">
                                        <div class=""><img src="/assets/img/icons/seleccionar.svg"></div>
                                        <div class="title">SELECCIONAR</div>
                                    </button>
                                    `;
                                }
                            }
                        }
                    ]
                ,result.archivos); 

});

fechData('/configuraciones/getAll','GET')
.then((result)=>{
    dataTableConfig('tablaConfiguraciones',
                    [
                        {
                            data:'color_letra',
                            title:'Color de la Letra',
                            render: function(data,type, row){
                                return `<p style="color:${data}">${data}</p>`
                            }
                        },
                        {data:'tamanio_letra',title:'Tamaño de la Letra'},
                        {data:'estilo_letra',title:'Estilo de la Letra'},
                        {data:'cat_apartados_firma.apartado_firma',title:'Apartado'},
                        {
                            data: 'activo', 
                            title: "Seleccionar",
                            render: function(data, type, row) {
                            if (data === true) {
                                return '<span class="badge text-bg-success" >Seleccionado</span>';
                            } else {
                                // Si está inactivo, muestra botón
                                return `
                                    <button class="btn primary" type="button" onclick="activar(${row.id_configuracion},${row.cat_apartados_firma.id_cat_apartado_firma})">
                                        <div class=""><img src="/assets/img/icons/seleccionar.svg"></div>
                                        <div class="title">SELECCIONAR</div>
                                    </button>
                                `;
                            }
                        }
                        }
                    ]
                ,result.configuraciones); 

});



    function previewImage(event, querySelector){

	let input = event.target;
	

	let imgPreview = document.querySelector(querySelector);


	if(!input.files.length) return
	

	let file = input.files[0];

	let objectURL = URL.createObjectURL(file);
	
	imgPreview.src = objectURL;
                
}

function quitarImagen(querySelector){
    let file = document.getElementById('file').value = "";
	let imgPreview = document.querySelector(querySelector);
    imgPreview.src = "";
}

async function addConfiguracion(){
    try {
        const url = "/configuracion/add";
        const color_letra = document.getElementById('color_letra').value;
        const tamanio_letra = document.getElementById('tamanio_letra').value;
        const estilo_letra = document.getElementById('estilo_letra').value;
        const fk_id_cat_apartado_firma = document.getElementById('fk_id_cat_apartado_firma').value;
    
        if(color_letra == "" || tamanio_letra == "" || fk_id_cat_apartado_firma == ""){
            $.alert({
                title: "Advertencia",
                content: `<strong>Favor de agregar los campos requeridos <span style="color:red;font-weight:800">*</spant</strong>`,
                theme: 'modern',
                icon: 'fa-solid fa-triangle-exclamation',
                type: "red"
            });
        }else{
    
            const response = await fetch(url,{
                method:"POST",
                        headers: {
                    "Content-Type": "application/json",
                },
                body:JSON.stringify({color_letra,tamanio_letra,estilo_letra,fk_id_cat_apartado_firma})
            });
    
            if(response.ok){
                const data = await response.json();
                clearForm()
                window.location.reload();
                console.log(data);
            }else{
            $.alert({
                title: "Advertencia",
                content: `<strong>No se puedo agregar la configuración</strong>`,
                theme: 'modern',
                icon: 'fa-solid fa-triangle-exclamation',
                type: "red"
            });
            }
        }
        
    } catch (error) {
        console.error(error);
    }
    
} 



function clearForm(){
    const color_letra = document.getElementById('color_letra').value ="#611232";
    const tamanio_letra = document.getElementById('tamanio_letra').value = "";
    const estilo_letra = document.getElementById('estilo_letra').value = "";
    const fk_id_cat_apartado_firma = document.getElementById('fk_id_cat_apartado_firma').value = "";
}

async function activar(id,id_apartado){
    try {
        
        const url = "/configuracion/active/"+id;
        const checkActivarConfig = document.getElementById('activarConfig');
        let activo = true;
    
        const response = await fetch(url,{
    
            method:"POST",
                    headers: {
                "Content-Type": "application/json",
            },
            body:JSON.stringify({activo,id_apartado})
        });
        if(response.ok){
            const data = await response.json();
            console.log(data);
            window.location.reload();
        }
    } catch (error) {
        console.error(error)
    }
}

async function activarImage(id){

    try {
        const url = "/configuracion/file/active/"+ id;
            let activo = true;
    
        const response = await fetch(url,{
    
            method:"POST",
                    headers: {
                "Content-Type": "application/json",
            },
            body:JSON.stringify({activo})
        });
        if(response.ok){
            const data = await response.json();
            console.log(data);
            window.location.reload();
        }
        
    } catch (error) {
          console.error(error);
    }
}


async function agregarArchivo(){
    try {
        const formData = new FormData();
        const inputFile = document.getElementById('file');
        if(!inputFile.files[0]){
            $.alert({
                title: "Advertencia",
                content: `<strong>Favor de seleccionar un archivo de imagen</strong>`,
                theme: 'modern',
                icon: 'fa-solid fa-triangle-exclamation',
                type: "red"
            });
        }else{
            formData.append('file',inputFile.files[0]);
            const file = inputFile.files[0];
            const url = "/configuracion/file";
        
            const response = await fetch(url,{
        
                method:"POST",
                body:formData
            });
    
            if(response.ok){
                const data = await response.json();
                quitarImagen('#imgPreview');
                window.location.reload();
            }
        
    
            console.log(data);
        }
        
    } catch (error) {
        console.error(error)
    }
}
</script>
